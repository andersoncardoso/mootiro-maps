(function(){var e=Object.prototype.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["require","jquery","underscore","backbone","app","urls","map/views","text!templates/main/_upper_bar.html","text!templates/main/_header.html","text!templates/main/_footer.html","text!templates/main/_action_bar.html","text!templates/main/_map_editor.html"],function(e){var n,r,i,s,o,u,a,f,l,c,h,p;return n=e("jquery"),p=e("underscore"),i=e("backbone"),l=e("app"),h=e("urls"),c=e("map/views"),s=function(e){function n(){n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="span",n.prototype.className="feedback",n.prototype.delay=100,n.prototype.initialize=function(){var e=this;return this.$el.hide(),this.listenTo(l,"working",function(){return e.open(i18n("Working..."))}),this.listenTo(l,"done",function(){return e.close()}),this.render()},n.prototype.open=function(e){var t=this;return this.$el.html(e),this.delayed==null&&(this.delayed=setTimeout(function(){return t.$el.css({display:"inline"})},this.delay)),this},n.prototype.close=function(){return clearTimeout(this.delayed),this.delayed=null,this.$el.fadeOut(),this},n}(i.View),f=function(n){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.template=p.template(e("text!templates/main/_upper_bar.html")),r.prototype.events={"click .login":"login","click .logout":"logout","click .user":"profile"},r.prototype.initialize=function(){var e=this;return p.bindAll(this),this.listenTo(this.model,"change",this.render),this.listenTo(l,"change",function(t){if(e.model.id===t.id&&e.model.constructor===t.constructor)return e.model.fetch()}),this.render()},r.prototype.render=function(){return this.$el.html(this.template({user:this.model.toJSON()})),this},r.prototype.login=function(e){return e!=null&&e.preventDefault(),l.trigger("login",window.location.href),this},r.prototype.logout=function(e){return e!=null&&e.preventDefault(),l.trigger("logout",window.location.href),this},r.prototype.profile=function(e){var t;return e!=null&&e.preventDefault(),t=new this.model.constructor(this.model.toJSON()),t.view(),this},r}(i.View),u=function(r){function i(){i.__super__.constructor.apply(this,arguments)}return t(i,r),i.prototype.template=p.template(e("text!templates/main/_header.html")),i.prototype.events={"click .logo a":"root","click nav a":"nav"},i.prototype.urls={".map":h.resolve("map")},i.prototype.initialize=function(){return p.bindAll(this),this.subViews=[],this.subViews.push(new f({model:this.model,parentSelector:"#upper-bar-container"})),this.render()},i.prototype.setUrls=function(){var e,t;t=[];for(e in this.urls)t.push(this.$(""+e+" a").attr({href:this.urls[e]}));return t},i.prototype.render=function(){var e,t,n,r,i,s,o;s=this.subViews;for(t=0,r=s.length;t<r;t++)e=s[t],e.$el.detach();this.$el.html(this.template({user:this.model.toJSON()})),this.setUrls(),o=this.subViews;for(n=0,i=o.length;n<i;n++)e=o[n],this.$(e.options.parentSelector).append(e.$el);return this},i.prototype.root=function(e){return e!=null&&e.preventDefault(),l.goTo("")},i.prototype.nav=function(e){var t;return e!=null&&e.preventDefault(),t=n(e.target).attr("href"),l.goTo(t)},i}(i.View),o=function(n){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.template=p.template(e("text!templates/main/_footer.html")),r.prototype.initialize=function(){return p.bindAll(this),this.render()},r.prototype.render=function(){return this.$el.html(this.template()),this},r}(i.View),r=function(r){function i(){i.__super__.constructor.apply(this,arguments)}return t(i,r),i.prototype.template=p.template(e("text!templates/main/_action_bar.html")),i.prototype.tagName="ul",i.prototype.events={"click a":"do"},i.prototype.actions=[{action:"edit",label:i18n("Edit")},{action:"rate",label:i18n("Rate")},{action:"discuss",label:i18n("Discuss")},{action:"history",label:i18n("History")},{action:"report",label:i18n("Report")},{action:"delete",label:i18n("Delete")}],i.prototype.initialize=function(){return p.bindAll(this),this.mode=this.options.mode,this.listenTo(this.model,"change",this.render),this.listenTo(l,"login logout change:session",this.render),this.render()},i.prototype.render=function(){return this.$el.html(this.template({actions:this.actions,model:this.model.toJSON(),hasPermission:p.bind(this.model.hasPermission,this.model)})),this.setMode(this.mode),this},i.prototype["do"]=function(e){var t,r,i,s;return e.preventDefault(),t=n(e.target).hasClass("active")?"show":n(e.target).attr("data-action"),r=typeof (i=this.model)[s=""+t+"Url"]=="function"?i[s]():void 0,l.goTo(r)},i.prototype.setMode=function(e){return this.mode=e,this.$(".active").removeClass("active"),this.$("a[data-action="+e+"]").addClass("active")},i}(i.View),a=function(r){function i(){i.__super__.constructor.apply(this,arguments)}return t(i,r),i.prototype.template=p.template(e("text!templates/main/_map_editor.html")),i.prototype.className="map-editor",i.prototype.initialize=function(){var e=this;return p.bindAll(this),this.subViews=[],this.mapEditor=new c.Editor({parentSelector:"#map-container"}),this.subViews.push(this.mapEditor),this.listenTo(this.mapEditor,"initialize",function(){return e.trigger("initialize")}),n(window).resize(this.resizeElement),this.render()},i.prototype.resizeElement=function(){var e,t,r,i;return t=n("#header-container"),i=t.offset().top+t.height(),e=n(document).height(),r=e-i,this.$("#map-editor").css({height:r})},i.prototype.render=function(){var e,t,n,r,i,s,o;s=this.subViews;for(t=0,r=s.length;t<r;t++)e=s[t],e.$el.detach();this.$el.html(this.template({})),o=this.subViews;for(n=0,i=o.length;n<i;n++)e=o[n],this.$(e.options.parentSelector).append(e.$el);return this.resizeElement(),this},i.prototype.getMap=function(){return this.mapEditor.getMap()},i}(i.View),{Header:u,Footer:o,UpperBar:f,ActionBar:r,Feedback:s,MapEditor:a}})}).call(this);