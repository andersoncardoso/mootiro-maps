(function(){var CheckboxWidget,DropdownWidget,FormView,PasswordWidget,TextAreaWidget,TextWidget,Widget,checkboxTemplate,dropdownTemplate,fieldTemplate,formTemplate,textTemplate,textareaTemplate;formTemplate="<form action=\"\" method=\"post\" id=\"<%= formId %>\" >\n    <div>\n        <input type=\"submit\" name=\"submit\" value=\"<%=submit_label%>\" />\n    </div>\n</form>";fieldTemplate="<div class=\"field-container <%=container_class%>\" for=\"<%=name%>\" >\n    <label><%=label%></label>\n    <div class=\"widget-container\">\n    </div>\n</div>";textTemplate="<input type=\"<%=type%>\" name=\"<%=name%>\" value=\"<%=value%>\" id=\"id_<%=name%>\" <%=attrs%> />";textareaTemplate="<textarea name=\"<%=name%>\" id=\"id_<%=name%>\" <%=attrs%>><%=value%></textarea>";checkboxTemplate="<label>\n  <input type=\"checkbox\" name=\"<%=name%>\" value=\"<%=choice_value%>\" id=\"id_<%=name%>_<%=choice_num%>\" class=\"checkbox\" />\n  <%=choice_title%>\n</label>";dropdownTemplate="<select name=\"<%=name%>\" id=\"id_<%=name%>\" <%=attrs%>>\n  <%_.each(choices, function (choice) {%>\n    <option value=\"<%=choice.value%>\" <%=choice.attrs%>><%=choice.title%></option>\n  <% }); %>\n</select>";Widget=Backbone.View.extend({initialize:function(){var _base;_.bindAll(this);this._template=_.template(this.template);if((_base=this.options).attrs==null)_base.attrs='';return this.name=this.options.name;},render:function(){this.$el.html(this._template(this.options));if(typeof this.behavior==="function")this.behavior();return this;},getInputElement:function(){return this.$("input[name="+this.name+"]");},set:function(value){return this.getInputElement().val(value);},get:function(){return this.getInputElement().val();}});TextWidget=Widget.extend({template:textTemplate,initialize:function(){this.options.type='text';return Widget.prototype.initialize.apply(this,arguments);}});PasswordWidget=Widget.extend({template:textTemplate,initialize:function(){this.options.type='password';this.options.value='';this.options.attrs='autocomplete="off"';return Widget.prototype.initialize.apply(this,arguments);}});TextAreaWidget=Widget.extend({template:textareaTemplate,getInputElement:function(){return this.$('textarea');}});CheckboxWidget=Widget.extend({template:checkboxTemplate,render:function(){var args,idx,option,renderedChoice,_ref;this.$el.html('');_ref=this.options.choices;for(idx in _ref){option=_ref[idx];args=_.extend(this.options,{choice_value:option.value,choice_title:option.title,choice_num:idx+1});renderedChoice=this._template(args);this.$el.append(renderedChoice);}
return this;},set:function(value){if(value){return this.$("input[value="+value+"]").attr('checked',true);}else{return this.$(":checked").attr('checked',false);}},get:function(){var checked;checked=this.$(":checked");if(checked.length){return checked.val();}else{return'';}}});DropdownWidget=Widget.extend({template:dropdownTemplate,initialize:function(){var _base;if((_base=this.options).choices==null)_base.choices=[];return Widget.prototype.initialize.apply(this,arguments);},getInputElement:function(){return this.$("select[name="+this.options.name+"]");}});FormView=Backbone.View.extend({template:formTemplate,initialize:function(){var cb_name,event,_ref,_ref2,_ref3,_ref4;_.bindAll(this);this._template=_.template(this.template);if((_ref=this.options)!=null?_ref.model:void 0){this.model=this.options.model;}
this.patch=(_ref2=(_ref3=this.options)!=null?_ref3.patch:void 0)!=null?_ref2:false;this.renderedFields=[];this.instances={};this.on('submit',this.save);if(this.events!=null){_ref4=this.events;for(event in _ref4){cb_name=_ref4[event];this.on(event,this[cb_name]);}}
return this.initializeFields();},render:function(){var id,renderedField,renderedFormTemplate,submit_label,_i,_j,_len,_len2,_ref,_ref2,_ref3,_ref4,_this=this;_ref=this.renderedFields;for(_i=0,_len=_ref.length;_i<_len;_i++){renderedField=_ref[_i];renderedField.detach();}
id=((_ref2=this.options)!=null?_ref2.formId:void 0)||'';submit_label=((_ref3=this.options)!=null?_ref3.submit_label:void 0)||(_.isFunction(window.i18n)?i18n('send'):'send');renderedFormTemplate=this._template({formId:id,submit_label:submit_label});this.$el.html(renderedFormTemplate);_ref4=this.renderedFields;for(_j=0,_len2=_ref4.length;_j<_len2;_j++){renderedField=_ref4[_j];this.$('form').prepend(renderedField);}
this.$('form').submit(function(evt){evt.preventDefault();return _this.trigger('submit');});if(this.model)this.set(this.model.toJSON());return this;},remove:function(){Backbone.View.prototype.initialize.apply(this,arguments);this.clearInstances();return this.clearRenderedFields();},clearInstances:function(){var instance,name,_ref,_results;_ref=this.instances;_results=[];for(name in _ref){instance=_ref[name];instance.remove();_results.push(this.instances[name]=null);}
return _results;},clearRenderedFields:function(){var renderedField,_i,_len,_ref;_ref=this.renderedFields;for(_i=0,_len=_ref.length;_i<_len;_i++){renderedField=_ref[_i];renderedField.remove();}
return this.renderedFields.length=0;},initializeFields:function(){var args,container,field,renderedField,widget,_fieldTemplate,_i,_len,_ref,_results;_ref=this.fields.slice(0).reverse();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){field=_ref[_i];args={name:field.name,input_id:"id_"+field.name,label:field.label||'',value:field.value||'',container_class:field.container_class||''};args=_.extend(args,field.args||{});widget=new field.widget(args);this.instances[field.name]=widget;_fieldTemplate=_.template(fieldTemplate);container=$('<div>').html(_fieldTemplate(args));renderedField=container.children().detach();renderedField.find('.widget-container').append(widget.render().el);this.$('form').prepend(renderedField);this.renderedFields.push(renderedField);if(this.model){_results.push(this.set(this.model.toJSON()));}else{_results.push(void 0);}}
return _results;},disableSubmit:function(){return this.$('input[type=submit]').attr('disabled','disabled');},enableSubmit:function(){return this.$('input[type=submit]').removeAttr('disabled');},save:function(){var _this=this;this.disableSubmit();return this.model.save(this.get(),{wait:true,patch:this.patch,success:function(model,resp){_this.cleanErrors();_this.enableSubmit();if(resp.redirect){if(window.location.pathname===resp.redirect){window.location.reload();}else{window.location=resp.redirect;}}
return _this.trigger('success',resp);},error:function(model,resp){_this.enableSubmit();resp=JSON.parse(resp.responseText);_this.cleanErrors();_this.errors(resp.errors||{});return _this.trigger('error',resp);}});},errors:function(vals){var field,msg,name,submit_btn;if(this._errors==null)this._errors={};if(vals){this._errors=_.extend(this._errors,vals);for(name in vals){msg=vals[name];if(name==='__all__'){submit_btn=this.$("input[type=submit]");if(submit_btn.length&&!submit_btn.parent().find('small.error').length){submit_btn.before("<small class='error'>"+msg+"</small>");}}
field=this.$(".field-container[for="+name+"]");field.find("#id_"+name).addClass('error');field.find("label").addClass('error');if(!field.find("small.error").length){field.find(".widget-container").after("<small class='error'>"+msg+"</smalll>");}}}else{return this._errors;}},cleanErrors:function(){this.$('small.error').remove();return this.$('.error').removeClass('error');},get:function(fieldName){var field,vals,_i,_len,_ref;if(fieldName==null)fieldName='__all__';if(fieldName==='__all__'){vals={};_ref=this.fields;for(_i=0,_len=_ref.length;_i<_len;_i++){field=_ref[_i];vals[field.name]=this.instances[field.name].get();}
return vals;}else{field=_.find(this.fields,function(f){return f.name===fieldName;});return this.instances[field.name].get();}},set:function(vals){var field,key,value,_ref,_results;if(vals==null)vals={};_results=[];for(key in vals){value=vals[key];field=_.find(this.fields,function(f){return f.name===key;});_results.push((_ref=this.instances[field!=null?field.name:void 0])!=null?typeof _ref.set==="function"?_ref.set(value):void 0:void 0);}
return _results;}});window.ReForm={Form:FormView,Widget:Widget,commonWidgets:{TextWidget:TextWidget,PasswordWidget:PasswordWidget,TextAreaWidget:TextAreaWidget,CheckboxWidget:CheckboxWidget,DropdownWidget:DropdownWidget}};if(typeof define==="function"&&define.amd){define(function(){return window.ReForm;});}}).call(this);(function(){var formTemplate,_base;formTemplate="<form action=\"\" method=\"post\" id=\"<%= formId %>\" >\n    <div class=\"form-actions\">\n        <input class=\"btn button\" type=\"submit\" name=\"submit\" value=\"<%=submit_label%>\" />\n    </div>\n</form>";if(window.KomooNS==null)window.KomooNS={};if((_base=window.KomooNS).templates==null)_base.templates={};window.KomooNS.templates.formTemplate=formTemplate;}).call(this);(function($){$.fn.markItUp=function(settings,extraSettings){var options,ctrlKey,shiftKey,altKey;ctrlKey=shiftKey=altKey=false;options={id:'',nameSpace:'',root:'',previewInWindow:'',previewAutoRefresh:true,previewPosition:'after',previewTemplatePath:'~/templates/preview.html',previewParserPath:'',previewParserVar:'data',resizeHandle:true,beforeInsert:'',afterInsert:'',onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};$.extend(options,settings,extraSettings); if(!options.root){$('script').each(function(a,tag){miuScript=$(tag).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);if(miuScript!==null){options.root=miuScript[1];}});}
return this.each(function(){var $$,textarea,levels,scrollPosition,caretPosition,caretOffset,clicked,hash,header,footer,previewWindow,template,iFrame,abort;$$=$(this);textarea=this;levels=[];abort=false;scrollPosition=caretPosition=0;caretOffset=-1;options.previewParserPath=localize(options.previewParserPath);options.previewTemplatePath=localize(options.previewTemplatePath);function localize(data,inText){if(inText){return data.replace(/("|')~\//g,"$1"+options.root);}
return data.replace(/^~\//,options.root);} 
function init(){id='';nameSpace='';if(options.id){id='id="'+options.id+'"';}else if($$.attr("id")){id='id="markItUp'+($$.attr("id").substr(0,1).toUpperCase())+($$.attr("id").substr(1))+'"';}
if(options.nameSpace){nameSpace='class="'+options.nameSpace+'"';}
$$.wrap('<div '+nameSpace+'></div>');$$.wrap('<div '+id+' class="markItUp"></div>');$$.wrap('<div class="markItUpContainer"></div>');$$.addClass("markItUpEditor"); header=$('<div class="markItUpHeader"></div>').insertBefore($$);$(dropMenus(options.markupSet)).appendTo(header); footer=$('<div class="markItUpFooter"></div>').insertAfter($$); if(options.resizeHandle===true&&$.browser.safari!==true){resizeHandle=$('<div class="markItUpResizeHandle"></div>').insertAfter($$).bind("mousedown",function(e){var h=$$.height(),y=e.clientY,mouseMove,mouseUp;mouseMove=function(e){$$.css("height",Math.max(20,e.clientY+h-y)+"px");return false;};mouseUp=function(e){$("html").unbind("mousemove",mouseMove).unbind("mouseup",mouseUp);return false;};$("html").bind("mousemove",mouseMove).bind("mouseup",mouseUp);});footer.append(resizeHandle);} 
$$.keydown(keyPressed).keyup(keyPressed); $$.bind("insertion",function(e,settings){if(settings.target!==false){get();}
if(textarea===$.markItUp.focused){markup(settings);}}); $$.focus(function(){$.markItUp.focused=this;});} 
function dropMenus(markupSet){var ul=$('<ul></ul>'),i=0;$('li:hover > ul',ul).css('display','block');$.each(markupSet,function(){var button=this,t='',title,li,j;title=(button.key)?(button.name||'')+' [Ctrl+'+button.key+']':(button.name||'');key=(button.key)?'accesskey="'+button.key+'"':'';if(button.separator){li=$('<li class="markItUpSeparator">'+(button.separator||'')+'</li>').appendTo(ul);}else{i++;for(j=levels.length-1;j>=0;j--){t+=levels[j]+"-";}
li=$('<li class="markItUpButton markItUpButton'+t+(i)+' '+(button.className||'')+'"><a href="" '+key+' title="'+title+'">'+(button.name||'')+'</a></li>').bind("contextmenu",function(){ return false;}).click(function(){return false;}).mousedown(function(){if(button.call){eval(button.call)();}
setTimeout(function(){markup(button)},1);return false;}).hover(function(){$('> ul',this).show();$(document).one('click',function(){ $('ul ul',header).hide();});},function(){$('> ul',this).hide();}).appendTo(ul);if(button.dropMenu){levels.push(i);$(li).addClass('markItUpDropMenu').append(dropMenus(button.dropMenu));}}});levels.pop();return ul;} 
function magicMarkups(string){if(string){string=string.toString();string=string.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(x,a){var b=a.split('|!|');if(altKey===true){return(b[1]!==undefined)?b[1]:b[0];}else{return(b[1]===undefined)?"":b[0];}});string=string.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(x,a){var b=a.split(':!:');if(abort===true){return false;}
value=prompt(b[0],(b[1])?b[1]:'');if(value===null){abort=true;}
return value;});return string;}
return"";} 
function prepare(action){if($.isFunction(action)){action=action(hash);}
return magicMarkups(action);} 
function build(string){openWith=prepare(clicked.openWith);placeHolder=prepare(clicked.placeHolder);replaceWith=prepare(clicked.replaceWith);closeWith=prepare(clicked.closeWith);if(replaceWith!==""){block=openWith+replaceWith+closeWith;}else if(selection===''&&placeHolder!==''){block=openWith+placeHolder+closeWith;}else{block=openWith+(string||selection)+closeWith;}
return{block:block,openWith:openWith,replaceWith:replaceWith,placeHolder:placeHolder,closeWith:closeWith};} 
function markup(button){var len,j,n,i;hash=clicked=button;get();$.extend(hash,{line:"",root:options.root,textarea:textarea,selection:(selection||''),caretPosition:caretPosition,ctrlKey:ctrlKey,shiftKey:shiftKey,altKey:altKey}); prepare(options.beforeInsert);prepare(clicked.beforeInsert);if(ctrlKey===true&&shiftKey===true){prepare(clicked.beforeMultiInsert);}
$.extend(hash,{line:1});if(ctrlKey===true&&shiftKey===true){lines=selection.split(/\r?\n/);for(j=0,n=lines.length,i=0;i<n;i++){if($.trim(lines[i])!==''){$.extend(hash,{line:++j,selection:lines[i]});lines[i]=build(lines[i]).block;}else{lines[i]="";}}
string={block:lines.join('\n')};start=caretPosition;len=string.block.length+(($.browser.opera)?n:0);}else if(ctrlKey===true){string=build(selection);start=caretPosition+string.openWith.length;len=string.block.length-string.openWith.length-string.closeWith.length;len-=fixIeBug(string.block);}else if(shiftKey===true){string=build(selection);start=caretPosition;len=string.block.length;len-=fixIeBug(string.block);}else{string=build(selection);start=caretPosition+string.block.length;len=0;start-=fixIeBug(string.block);}
if((selection===''&&string.replaceWith==='')){caretOffset+=fixOperaBug(string.block);start=caretPosition+string.openWith.length;len=string.block.length-string.openWith.length-string.closeWith.length;caretOffset=$$.val().substring(caretPosition,$$.val().length).length;caretOffset-=fixOperaBug($$.val().substring(0,caretPosition));}
$.extend(hash,{caretPosition:caretPosition,scrollPosition:scrollPosition});if(string.block!==selection&&abort===false){insert(string.block);set(start,len);}else{caretOffset=-1;}
get();$.extend(hash,{line:'',selection:selection}); if(ctrlKey===true&&shiftKey===true){prepare(clicked.afterMultiInsert);}
prepare(clicked.afterInsert);prepare(options.afterInsert); if(previewWindow&&options.previewAutoRefresh){refreshPreview();} 
shiftKey=altKey=ctrlKey=abort=false;} 
function fixOperaBug(string){if($.browser.opera){return string.length-string.replace(/\n*/g,'').length;}
return 0;} 
function fixIeBug(string){if($.browser.msie){return string.length-string.replace(/\r*/g,'').length;}
return 0;} 
function insert(block){if(document.selection){var newSelection=document.selection.createRange();newSelection.text=block;}else{$$.val($$.val().substring(0,caretPosition)+block+$$.val().substring(caretPosition+selection.length,$$.val().length));}} 
function set(start,len){if(textarea.createTextRange){ if($.browser.opera&&$.browser.version>=9.5&&len==0){return false;}
range=textarea.createTextRange();range.collapse(true);range.moveStart('character',start);range.moveEnd('character',len);range.select();}else if(textarea.setSelectionRange){textarea.setSelectionRange(start,start+len);}
textarea.scrollTop=scrollPosition;textarea.focus();} 
function get(){textarea.focus();scrollPosition=textarea.scrollTop;if(document.selection){selection=document.selection.createRange().text;if($.browser.msie){ var range=document.selection.createRange(),rangeCopy=range.duplicate();rangeCopy.moveToElementText(textarea);caretPosition=-1;while(rangeCopy.inRange(range)){rangeCopy.moveStart('character');caretPosition++;}}else{ caretPosition=textarea.selectionStart;}}else{ caretPosition=textarea.selectionStart;selection=$$.val().substring(caretPosition,textarea.selectionEnd);}
return selection;} 
function preview(){if(!previewWindow||previewWindow.closed){if(options.previewInWindow){previewWindow=window.open('','preview',options.previewInWindow);}else{iFrame=$('<iframe class="markItUpPreviewFrame"></iframe>');if(options.previewPosition=='after'){iFrame.insertAfter(footer);}else{iFrame.insertBefore(header);}
previewWindow=iFrame[iFrame.length-1].contentWindow||frame[iFrame.length-1];}}else if(altKey===true){ if(iFrame){iFrame.remove();}else{previewWindow.close();}
previewWindow=iFrame=false;}
if(!options.previewAutoRefresh){refreshPreview();}} 
function refreshPreview(){renderPreview();}
function renderPreview(){var phtml;if(options.previewParserPath!==''){$.ajax({type:'POST',url:options.previewParserPath,data:options.previewParserVar+'='+encodeURIComponent($$.val()),success:function(data){writeInPreview(localize(data,1));}});}else{if(!template){$.ajax({url:options.previewTemplatePath,success:function(data){writeInPreview(localize(data,1).replace(/<!-- content -->/g,$$.val()));}});}}
return false;}
function writeInPreview(data){if(previewWindow.document){try{sp=previewWindow.document.documentElement.scrollTop}catch(e){sp=0;}
previewWindow.document.open();previewWindow.document.write(data);previewWindow.document.close();previewWindow.document.documentElement.scrollTop=sp;}
if(options.previewInWindow){previewWindow.focus();}} 
function keyPressed(e){shiftKey=e.shiftKey;altKey=e.altKey;ctrlKey=(!(e.altKey&&e.ctrlKey))?e.ctrlKey:false;if(e.type==='keydown'){if(ctrlKey===true){li=$("a[accesskey="+String.fromCharCode(e.keyCode)+"]",header).parent('li');if(li.length!==0){ctrlKey=false;setTimeout(function(){li.triggerHandler('mousedown');},1);return false;}}
if(e.keyCode===13||e.keyCode===10){ if(ctrlKey===true){ ctrlKey=false;markup(options.onCtrlEnter);return options.onCtrlEnter.keepDefault;}else if(shiftKey===true){ shiftKey=false;markup(options.onShiftEnter);return options.onShiftEnter.keepDefault;}else{ markup(options.onEnter);return options.onEnter.keepDefault;}}
if(e.keyCode===9){ if(shiftKey==true||ctrlKey==true||altKey==true){return false;}
if(caretOffset!==-1){get();caretOffset=$$.val().length-caretOffset;set(caretOffset,0);caretOffset=-1;return false;}else{markup(options.onTab);return options.onTab.keepDefault;}}}}
init();});};$.fn.markItUpRemove=function(){return this.each(function(){var $$=$(this).unbind().removeClass('markItUpEditor');$$.parent('div').parent('div.markItUp').parent('div').replaceWith($$);});};$.markItUp=function(settings){var options={target:false};$.extend(options,settings);if(options.target){return $(options.target).each(function(){$(this).focus();$(this).trigger('insertion',[options]);});}else{$('textarea').trigger('insertion',[options]);}};})(jQuery);mySettings={previewParserPath:'/markitup/preview/',onShiftEnter:{keepDefault:false,openWith:'\n\n'},markupSet:[{name:'Título (1o nível)',key:'1',placeHolder:'Seu título aqui...',closeWith:function(markItUp){return miu.markdownTitle(markItUp,'=')}},{name:'Título (2o nível)',key:'2',placeHolder:'Seu título aqui...',closeWith:function(markItUp){return miu.markdownTitle(markItUp,'-')}},{name:'Título (3o nível)',key:'3',openWith:'### ',placeHolder:'Seu título aqui...'},{name:'Título (4o nível)',key:'4',openWith:'#### ',placeHolder:'Seu título aqui...'},{name:'Título (5o nível)',key:'5',openWith:'##### ',placeHolder:'Seu título aqui...'},{name:'Título (6o nível)',key:'6',openWith:'###### ',placeHolder:'Seu título aqui...'},{separator:'---------------'},{name:'Negrito',key:'B',openWith:'**',closeWith:'**'},{name:'Itálico',key:'I',openWith:'_',closeWith:'_'},{separator:'---------------'},{name:'Lista não-ordenada',openWith:'- '},{name:'Lista ordenada',openWith:function(markItUp){return markItUp.line+'. ';}},{separator:'---------------'},{name:'Link',key:'L',openWith:'[',closeWith:']([![Url:!:http://]!] "[![Title]!]")',placeHolder:'Seu texto para linkar aqui...'},{separator:'---------------'},{name:'Citação',openWith:'> '},{name:'Código',openWith:'(!(\t|!|`)!)',closeWith:'(!(`)!)'},{separator:'---------------'},{name:'Visualização Prévia',call:'preview',className:"preview"}]}
miu={markdownTitle:function(markItUp,char){heading='';n=$.trim(markItUp.selection||markItUp.placeHolder).length; if(n<3){n=3;}
for(i=0;i<n;i++){heading+=char;}
return'\n'+heading;}}
(function(){var $,MarkItUpWidget,_base;$=jQuery;MarkItUpWidget=ReForm.Widget.extend({template:"<textarea class=\"markItUpEditor\" name=\"<%=name%>\" id=\"id_<%=name%>\" value=\"<%=value%>\">",behavior:function(){var _this=this;return $(document).ready(function(){_this.$el.find("#id_"+_this.name).markItUp(mySettings);return _this.$el.find('a[title="Preview"]').trigger('mouseup');});},getInputElement:function(){return this.$('textarea');}});if(window.KomooNS==null)window.KomooNS={};if((_base=window.KomooNS).widgets==null)_base.widgets={};window.KomooNS.widgets.MarkItUpWidget=MarkItUpWidget;}).call(this);(function(){var Resource,_base;Resource=Backbone.Model.extend({urlRoot:'/api/resources/'});if(window.KomooNS==null)window.KomooNS={};if((_base=window.KomooNS).models==null)_base.models={};window.KomooNS.models.Resource=Resource;}).call(this);(function(){var FormResource;FormResource=ReForm.Form.extend({template:window.KomooNS.templates.formTemplate,fields:[{name:'name',widget:ReForm.commonWidgets.TextWidget,label:'Name:'},{name:'description',widget:window.KomooNS.widgets.MarkItUpWidget,label:'Description:'}],events:{'success':'onSuccess'},onSuccess:function(data){return console.dir(data);}});$(function(){var form;form=new FormResource({formId:'form_resource',model:new window.KomooNS.models.Resource()});return $('#reForm-wrapper').html(form.render().el);});}).call(this);